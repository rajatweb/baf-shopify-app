// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Store model - represents a Shopify store
model Store {
  shop      String   @id // Shopify shop domain as primary key
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Music player settings
  musicPlayerSettings Json? // Player customization settings

  // Relationships
  playlists    Playlist[]
  tracks       Track[]
  subscription Subscription?
}

// Subscription model - tracks the store's current subscription
model Subscription {
  id                String   @id @default(cuid())
  shopId            String   @unique // One subscription per store
  shop              Store    @relation(fields: [shopId], references: [shop], onDelete: Cascade)
  
  // Subscription details
  subscriptionId    String?  // Shopify subscription ID
  planName          String   @default("Free Plan") // "Free Plan" or "Pro Plan"
  status            String   @default("INACTIVE") // "ACTIVE", "INACTIVE", "CANCELLED", etc.
  trialDays         Int?     // Trial period in days
  trialEndsAt       DateTime? // When trial ends
  
  // Plan limits (cached for performance)
  maxPlaylists      Int      @default(1)
  maxTracksPerPlaylist Int   @default(2)
  maxTotalTracks    Int      @default(2)
  persistentPlayback Boolean @default(false)
  fullCustomization Boolean  @default(false)
  homepageOnly      Boolean  @default(true)
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([shopId])
}

// Playlist model - represents a music playlist
model Playlist {
  id          String   @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  isSelected  Boolean  @default(false) // Only one playlist can be selected per store
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  storeId String
  store   Store @relation(fields: [storeId], references: [shop], onDelete: Cascade)
  tracks  PlaylistTrack[]

  @@index([storeId])
}

// Track model - represents a music track
model Track {
  id        String   @id @default(cuid())
  title     String
  artist    String
  albumArt  String?  // Shopify CDN URL to album art image
  audioUrl  String   // Shopify CDN URL to audio file
  duration  Int?     // Duration in seconds
  fileSize  Int?     // File size in bytes
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Shopify file references
  albumArtFileId String? // Shopify file ID for album art
  audioFileId    String? // Shopify file ID for audio file

  // Relationships
  storeId       String
  store         Store @relation(fields: [storeId], references: [shop], onDelete: Cascade)
  playlistTracks PlaylistTrack[]

  @@index([storeId])
}

// PlaylistTrack model - junction table for playlist-track relationships
model PlaylistTrack {
  id        String   @id @default(cuid())
  order     Int      // Track order in playlist
  createdAt DateTime @default(now())

  // Relationships
  playlistId String
  playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  trackId    String
  track      Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([playlistId, trackId])
  @@index([playlistId])
  @@index([trackId])
}
